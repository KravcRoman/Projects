# ЦУП + Телеграм-бот для управления системой парсеров

___

## Описание
Управление запуском и контроль сети парсеров. Телеграм-бот представляет собой удобный пользовательский интерфейс для клиента. Ядро проекта ```control_management_center.py``` - Центр Управления Парсерами (ЦУП). Запуск парсеров осуществляется через скрипт, который каждую минуту активируется CRON'ом.

## Версия Python
3.11.4

## Автор
surfer_liner

___

## Установка бота c ЦУП
Чтобы установить и запустить проект с ЦУП, выполните следующие шаги:

1. Переходим по ссылке и качаем репозиторий ЦУП на свой компьютер (бот в комплекте):

   ```bash
   https://gitflic.ru/project/metinvest-service/pcc/file?branch=v3_1_dev

2. Переходим в каталог проекта:

   ```bash
   cd pcc

3. Удаляем среду окружения:

   ```bash
   rm -r venv

4. Устанавливаем среду окружения:
   
   ```bash
   python3 -m venv venv

5. Активируем среду окружения:

   ```bash
   source venv/bin/activate

6. Устанавливаем необходимые зависимости с помощью pip:

    ```bash
   pip install -r requirements.txt

8. Переходим в корневую папку проекта, узнаем абсолютный путь:

   ```bash
   pwd

9. Копируем вывод и устанавливаем переменную среды:

   ```bash
   export PYTHONPATH=/абсолютный/путь/к/виртуальной/среде

10. Открываем ```start_parsers_script.py```, устанавливаем абсолютный путь до ```launch_plan.txt``` в переменную ```parsers_start_plan```


11. Открываем ```control_management_center.py```, устанавливаем значения переменных:

- ```IP_CMC``` - IP ЦУП 
- ```PORT_CMC``` - PORT ЦУП
- ```script_path``` - абсолютный путь к интерпретатору и абсолютный путь к ```start_parsers_script.py```

12. Открываем ```tg_bot.py```, устанавливаем токен в переменную ```TOKEN```

___

## Запуск процессов

1. Запускаем ```control_management_center.py```:

   ```bash
   nohup python3 control_management_center.py &

2. Запускаем ```tg_bot.py```:

   ```bash
   nohup python3 tg_bot.py &

___

## При добавлении нового парсера:

- Добавить в файл расписания запусков ```launch_plan.txt``` новый парсер с 
   установленным временем запуска в формате: ```ПАРСЕР_пробел_ВРЕМЯ(чч:мм)``` часовой пояс Москва    
- Добавить в ```control_management_center.py``` в ```PARSERS_URLS_DICT``` парсер и его URL 
- Добавить в скрипте запуска ```start_parsers_script.py```, в 
   словарь ```PARSERS_URLS_DICT``` парсер и его URL
- Добавить в ```tg_bot.py``` в словарь ```parsers_status_dict``` новый парсер и начальный статус  

___

## Использование
После успешного запуска приложения, вы можете взаимодействовать с ботом в Telegram. Ниже приведены доступные команды:

- /start - Главное меню с функциями управления парсерами
- /start_parsers - Запустить парсеры через CRON из ЦУП -> скрипт
- /stop_parsers - Остановить парсеры и удалить задачи CRON
- /status - Получить текущий статус всех парсеров
- /info - Ввести дату в формате "ДД-ММ" для получения журналов работы парсеров за указанный день

#### Рекомендуется пользоваться по следующему алгоритму:

- Установить в меню ```Расписание запуска``` время, в которое следует запустить парсер
- Нажать ```Запустить парсеры``` один раз - запустится CRON
- Отслеживать статус парсеров через ```Текущий статус```
- Просмотреть логирование основных операций в ```Сводка```
- Убить процессы и остановить крон через ```Остановить парсеры```

___

## Логирование
Логи работы приложения сохраняются в файл errors_tg_bot.log. Вы можете проверять этот файл, чтобы отслеживать ошибки и проблемы, возникающие в процессе работы бота.

___

## Зависимости
Проект использует следующие зависимости:

- Python 3.11.4
- telebot - библиотека для работы с Telegram API
- pytz - библиотека для работы с часовыми поясами
- Flask - микрофреймворк для создания веб-приложений
